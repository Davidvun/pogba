{% extends 'base.html' %}
{% block title %}{{ course.title }}{% endblock %}
{% block content %}
<h1 class="text-3xl font-bold mb-8">{{ course.title }}</h1>
<div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
    <div class="lg:col-span-3 space-y-6">
        {% for unit in units %}
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-bold mb-4">Unit {{ unit.order }}: {{ unit.title }}</h2>
            <p class="text-gray-600 mb-4">{{ unit.description }}</p>
            
            <div class="space-y-4">
                <h3 class="font-bold text-lg">Videos</h3>
                {% for video in unit.videos.all %}
                <div class="bg-gray-50 rounded-lg overflow-hidden">
                    <div class="p-4 bg-gray-100 border-b">
                        <h4 class="font-semibold text-lg">{{ video.title }}</h4>
                        <span class="text-sm text-gray-500">Duration: {{ video.duration }} seconds</span>
                    </div>
                    <div class="p-4">
                        {% if video.video_file %}
                            <video controls class="w-full rounded-lg" preload="metadata">
                                <source src="{{ video.video_file.url }}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                        {% elif video.video_url %}
                            {% if 'youtube.com' in video.video_url or 'youtu.be' in video.video_url %}
                                <div class="relative" style="padding-bottom: 56.25%; height: 0;">
                                    <iframe src="{{ video.video_url }}" frameborder="0" allowfullscreen class="absolute top-0 left-0 w-full h-full rounded-lg"></iframe>
                                </div>
                            {% elif 'vimeo.com' in video.video_url %}
                                <div class="relative" style="padding-bottom: 56.25%; height: 0;">
                                    <iframe src="{{ video.video_url }}" frameborder="0" allowfullscreen class="absolute top-0 left-0 w-full h-full rounded-lg"></iframe>
                                </div>
                            {% else %}
                                <video controls class="w-full rounded-lg" preload="metadata">
                                    <source src="{{ video.video_url }}" type="video/mp4">
                                    Your browser does not support the video tag.
                                </video>
                            {% endif %}
                        {% else %}
                            <p class="text-gray-500">Video not available</p>
                        {% endif %}
                        
                        {% if video.quiz %}
                        <div class="mt-4 p-3 {% if video.quiz.is_deadline_passed %}bg-red-50 border-red-200{% else %}bg-blue-50 border-blue-200{% endif %} border rounded-lg">
                            <p class="{% if video.quiz.is_deadline_passed %}text-red-800{% else %}text-blue-800{% endif %} font-semibold mb-2">üìù Quiz: {{ video.quiz.title }}</p>
                            {% if video.quiz.deadline %}
                            <p class="text-sm text-gray-600 mb-2">
                                <strong>Deadline:</strong> {{ video.quiz.deadline|date:"F d, Y g:i A" }}
                                {% if video.quiz.is_deadline_passed %}
                                    <span class="text-red-600 font-semibold">(Expired)</span>
                                {% endif %}
                            </p>
                            {% endif %}
                            {% if video.quiz.is_available %}
                                <a href="{% url 'take_quiz' video.quiz.id %}" class="inline-block px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Take Quiz</a>
                            {% elif video.quiz.is_deadline_passed %}
                                <p class="text-red-600 font-semibold">Quiz deadline has passed</p>
                            {% else %}
                                <p class="text-gray-600">Quiz is not currently active</p>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% empty %}
                <p class="text-gray-500 text-sm">No videos available</p>
                {% endfor %}
                
                <h3 class="font-bold text-lg mt-6">Materials</h3>
                {% for material in unit.materials.all %}
                <div class="p-4 bg-gray-50 rounded flex justify-between items-center">
                    <div>
                        <span class="font-medium">{{ material.title }}</span>
                        <span class="text-xs text-gray-500 ml-2">({{ material.get_material_type_display }})</span>
                    </div>
                    <div class="flex gap-2">
                        <a href="{% url 'view_material' material.id %}" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">View</a>
                        {% if material.is_downloadable %}<a href="{{ material.file.url }}" download class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">Download</a>{% endif %}
                    </div>
                </div>
                {% empty %}
                <p class="text-gray-500 text-sm">No materials available</p>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
    <div>
        <div class="bg-white rounded-lg shadow-md p-6 sticky top-4">
            <h3 class="font-bold mb-4">Your Progress</h3>
            <div class="w-full bg-gray-200 rounded-full h-4 mb-2">
                <div class="bg-blue-600 h-4 rounded-full" style="width: {{ enrollment.progress }}%"></div>
            </div>
            <p class="text-sm text-gray-600">{{ enrollment.progress|floatformat:0 }}% Complete</p>
        </div>
    </div>
</div>
{% endblock %}
